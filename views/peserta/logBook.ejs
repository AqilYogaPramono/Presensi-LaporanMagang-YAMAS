    <%- include('../partialsPeserta/__messages.ejs') %>
    <%- include('../partialsPeserta/__head.ejs', { title: 'Halaman Presensi dan Laporan' }) %>
    <%- include('../partialsPeserta/__nav-side.ejs') %>

    <style>
    .modal-fullscreen-custom .modal-dialog {
    max-width: 720px;
    margin: 1.2rem auto;
    height: auto;
    }
    @media (max-width: 576px) {
    .modal-fullscreen-custom .modal-dialog {
        max-width: 100%;
        margin: 0;
        height: 100%;
    }
    .modal-fullscreen-custom .modal-content {
        height: 100%;
        border-radius: 0;
    }
    }
    .pdf-shell {
    display: flex;
    flex-direction: column;
    min-height: 56vh;
    height: 100%;
    }
    .pdf-viewer-wrapper {
    position: relative;
    flex: 1 1 auto;
    display: flex;
    align-items: center;
    justify-content: center;
    background: #f7f9fb;
    border-top: 1px solid #eee;
    border-bottom: 1px solid #eee;
    padding: 12px;
    overflow: hidden;
    min-height: 280px;
    }
    .pdf-loader { display: none; text-align:center; font-size:0.95rem; color:#666; }
    .pdf-loader.show { display:block; }
    .pdf-loader .spinner-dots { display:inline-block; margin-right:8px; vertical-align:middle; }
    .pdf-loader .spinner-dots > i {
    display:inline-block; width:6px; height:6px; margin:0 2px; background:#6c757d; border-radius:50%; opacity:0.6;
    animation:dots 1s infinite linear;
    }
    .pdf-loader .spinner-dots > i:nth-child(2){ animation-delay:.15s; }
    .pdf-loader .spinner-dots > i:nth-child(3){ animation-delay:.30s; }
    @keyframes dots {
    0%{ transform:translateY(0); opacity:.6 }
    50%{ transform:translateY(-6px); opacity:1 }
    100%{ transform:translateY(0); opacity:.6 }
    }
    .pdf-viewer-wrapper iframe { width:100%; height:100%; border:none; box-shadow:0 1px 6px rgba(0,0,0,0.06); min-height:120px; display:block; }
    .pdf-error { padding:20px; }
    .table td, .table th { vertical-align: middle; }
    .table th, .table td { padding: 10px; }
    .table thead { background:#f8f9fa; }
    .btn-sm { font-size:0.85rem; padding:0.35rem 0.7rem; }
    .modal-content { display: flex; flex-direction: column; height: auto; }
    @media (max-width: 576px) {
    .modal-content { height: 100vh; }
    .pdf-shell { min-height: 0; height: 100%; }
    .pdf-viewer-wrapper { padding: 8px; min-height: 0; }
    }

    .btn-action {
    min-width: 140px;
    font-weight: 500;
    border-radius: 0.5rem;
    padding: 0.6rem 1.2rem;
    transition: all 0.3s ease;
    }

    .btn-action:hover:not(:disabled) {
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }

    .time-info {
    font-size: 0.85rem;
    color: #6c757d;
    margin-top: 0.25rem;
    }

    .current-time {
    font-size: 0.9rem;
    color: #6c757d;
    background-color: #e9ecef;
    padding: 0.5rem 1rem;
    border-radius: 0.5rem;
    display: inline-block;
    }

    .file-upload-area {
    border: 2px dashed #dee2e6;
    border-radius: 0.5rem;
    padding: 2rem;
    text-align: center;
    background-color: #f8f9fa;
    transition: all 0.3s ease;
    }

    .file-upload-area:hover {
    border-color: #007bff;
    background-color: #e3f2fd;
    }

    @media (max-width: 768px) {
    .btn-action {
        min-width: auto;
        width: 100%;
        margin-bottom: 0.5rem;
    }
    }
    </style>

    <div class="col-lg-12 grid-margin stretch-card">
    <div class="card">
        <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h4 class="card-title mb-0">
            <i class="mdi mdi-book-open-page-variant mr-2"></i>Presensi & Laporan Harian
            </h4>
            <div class="current-time" id="currentTime"></div>
        </div>

        <!-- Action Buttons -->
        <div class="row mb-4">
            <div class="col-md-4 mb-3">
            <form action="/peserta/presensi-masuk" method="POST" style="display: inline;">
                <button type="submit" id="btnPresensiMasuk" class="btn btn-success btn-action btn-block">
                <i class="mdi mdi-login mr-2"></i>Presensi Masuk
                </button>
            </form>
            <div class="time-info text-center">
                <i class="mdi mdi-clock-outline"></i> Jam 09:00 - 10:00
            </div>
            </div>
            
            <div class="col-md-4 mb-3">
            <form action="/peserta/presensi-keluar" method="POST" style="display: inline;">
                <button type="submit" id="btnPresensiKeluar" class="btn btn-warning btn-action btn-block">
                <i class="mdi mdi-logout mr-2"></i>Presensi Keluar
                </button>
            </form>
            <div class="time-info text-center">
                <i class="mdi mdi-clock-outline"></i> Jam 16:00 - 17:00
            </div>
            </div>
            
            <div class="col-md-4 mb-3">
            <button type="button" id="btnUploadLaporan" class="btn btn-info btn-action btn-block" data-toggle="modal" data-target="#modalUploadLaporan">
                <i class="mdi mdi-upload mr-2"></i>Upload Laporan
            </button>
            <div class="time-info text-center">
                <i class="mdi mdi-clock-outline"></i> Jam 16:00 - 23:59
            </div>
            </div>
        </div>

        <!-- Data Hari Ini -->
        <div class="card">
            <div class="card-header bg-light">
            <h5 class="mb-0 text-dark">
                <i class="mdi mdi-calendar-today mr-2"></i>Data Presensi Hari Ini
            </h5>
            </div>
            <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-striped table-hover table-bordered align-middle">
                <thead class="table-light">
                    <tr>
                    <th>Nama Peserta</th>
                    <th>Waktu Masuk</th>
                    <th>Waktu Keluar</th>
                    <th style="width:200px;">Laporan Harian</th>
                    </tr>
                </thead>
                <tbody id="dataTableBody">
                    <% if (dataNow && dataNow.length > 0) { %>
                    <% dataNow.forEach(function(item, i) { %>
                        <tr data-id="<% if (item.id) { %><%= item.id %><% } %>">
                        <td><strong><%= item.nama || 'Nama Peserta' %></strong></td>
                        <td>
                            <% if (item.waktu_absensi_masuk) { %>
                            <span class="text-success" data-waktu-masuk="true">
                                <%= new Date(item.waktu_absensi_masuk).toLocaleTimeString('id-ID', {hour: '2-digit', minute: '2-digit'}) %>
                            </span>
                            <% } else { %>
                            <span class="text-muted" data-waktu-masuk="false">Belum presensi</span>
                            <% } %>
                        </td>
                        <td>
                            <% if (item.waktu_absensi_keluar) { %>
                            <span class="text-warning" data-waktu-keluar="true">
                                <%= new Date(item.waktu_absensi_keluar).toLocaleTimeString('id-ID', {hour: '2-digit', minute: '2-digit'}) %>
                            </span>
                            <% } else { %>
                            <span class="text-muted" data-waktu-keluar="false">Belum presensi</span>
                            <% } %>
                        </td>
                        <td>
                            <div class="text-center">
                            <% if (item.laporan_harian) { %>
                            <button
                                type="button"
                                class="btn btn-sm btn-outline-primary show-pdf-btn mr-2"
                                data-toggle="modal"
                                data-target="#modalPdf"
                                data-id="<%= item.id || '' %>"
                                data-file="/file/laporan/<%= item.laporan_harian %>"
                                data-nama="<%= item.nama || 'Peserta' %>"
                                data-laporan="true">
                                <i class="mdi mdi-file-pdf-outline mr-1"></i>Detail
                            </button>
                            <% } else { %>
                            <span class="text-muted" data-laporan="false">Belum upload</span>
                            <% } %>
                            </div>
                        </td>
                        </tr>
                    <% }); %>
                    <% } else { %>
                    <tr>
                        <td colspan="4" class="text-center text-muted">Tidak ada data hari ini</td>
                    </tr>
                    <% } %>
                </tbody>
                </table>
            </div>
            </div>
        </div>
        </div>
    </div>
    </div>

    <!-- Modal Upload Laporan -->
    <div class="modal fade" id="modalUploadLaporan" tabindex="-1" role="dialog" aria-labelledby="modalUploadLaporanLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
        <div class="modal-header bg-primary text-white">
            <h5 class="modal-title" id="modalUploadLaporanLabel">
            <i class="mdi mdi-upload mr-2"></i>Upload Laporan Harian
            </h5>
            <button type="button" class="close text-white" data-dismiss="modal" aria-label="Tutup">
            <span aria-hidden="true">&times;</span>
            </button>
        </div>
        <form action="/peserta/laporan-harian-update" method="POST" enctype="multipart/form-data">
            <div class="modal-body">
            <div class="file-upload-area">
                <div class="mb-3">
                <i class="mdi mdi-file-pdf-outline" style="font-size: 3rem; color: #dc3545;"></i>
                </div>
                <h6>Pilih File PDF Laporan</h6>
                <p class="text-muted mb-3">Maksimal ukuran file 5MB</p>
                <input type="file" name="laporan_pdf" id="laporanFile" class="form-control-file" accept=".pdf" required>
            </div>
            <div class="mt-3">
                <small class="text-muted">
                <i class="mdi mdi-information-outline"></i>
                Laporan hanya dapat diupload antara jam 16:00 - 23:59
                </small>
            </div>
            </div>
            <div class="modal-footer">
            <button type="button" class="btn btn-light" data-dismiss="modal">Batal</button>
            <button type="submit" class="btn btn-primary">
                <i class="mdi mdi-upload mr-2"></i>Upload
            </button>
            </div>
        </form>
        </div>
    </div>
    </div>

    <!-- Modal PDF Viewer -->
    <div class="modal fade modal-fullscreen-custom" id="modalPdf" tabindex="-1" role="dialog" aria-labelledby="modalPdfLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
        <div class="pdf-shell">
            <div class="modal-header">
            <h5 class="modal-title" id="modalPdfLabel">Laporan Harian</h5>
            <div class="ml-auto d-flex align-items-center">
                <a href="#" id="downloadBtn" class="btn btn-sm btn-outline-secondary mr-2" target="_blank" rel="noopener" download>
                <i class="mdi mdi-download"></i> Download
                </a>
                <button type="button" class="close" data-dismiss="modal" aria-label="Tutup">
                <span aria-hidden="true">&times;</span>
                </button>
            </div>
            </div>

            <div class="modal-body p-0" style="flex:1 1 auto;">
            <div class="pdf-viewer-wrapper">
                <div class="pdf-loader" id="loader">
                <span class="spinner-dots"><i></i><i></i><i></i></span>
                Memuat dokumen, mohon tunggu…
                </div>

                <iframe id="pdfFrame" src="" frameborder="0" loading="lazy" title="Laporan Harian"></iframe>

                <div class="pdf-error text-center" id="error" style="display:none;">
                <p class="mb-2">Gagal memuat file. Coba buka di tab baru atau unduh file.</p>
                <a id="errorOpen" class="btn btn-outline-primary mr-2" target="_blank" rel="noopener">Buka di Tab Baru</a>
                <a id="errorDownload" class="btn btn-primary" download target="_blank" rel="noopener">Unduh</a>
                </div>
            </div>
            </div>

            <div class="modal-footer">
            <button type="button" class="btn btn-light" data-dismiss="modal">Tutup</button>
            <a id="openNewTab" href="#" target="_blank" rel="noopener" class="btn btn-primary">Buka di Tab Baru</a>
            </div>
        </div>
        </div>
    </div>
    </div>

    <%- include('../partialsPeserta/__script') %>

    <script>
    $(function() {
    // Data dari server (diambil dari data attributes HTML)
    let currentData = {};
    
    // Parsing data dari tabel
    function parseDataFromTable() {
        const tableRow = $('#dataTableBody tr').first();
        if (tableRow.length) {
        currentData = {
            id: tableRow.data('id'),
            nama: tableRow.find('td:first').text().trim(),
            sudahMasuk: tableRow.find('[data-waktu-masuk="true"]').length > 0,
            sudahKeluar: tableRow.find('[data-waktu-keluar="true"]').length > 0,
            sudahLaporan: tableRow.find('[data-laporan="true"]').length > 0
        };
        } else {
        currentData = {
            sudahMasuk: false,
            sudahKeluar: false,
            sudahLaporan: false
        };
        }
    }

    // Update waktu saat ini
    function updateCurrentTime() {
        const now = new Date();
        const timeString = now.toLocaleString('id-ID', {
        weekday: 'long',
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
        });
        $('#currentTime').text(timeString);
    }

    // Cek apakah waktu dalam rentang yang diizinkan
    function isTimeAllowed(startHour, endHour) {
        const now = new Date();
        const currentHour = now.getHours();
        return currentHour >= startHour && currentHour < endHour;
    }

    // Update status tombol berdasarkan waktu dan data
    function updateButtonStatus() {
        const btnPresensiMasuk = $('#btnPresensiMasuk');
        const btnPresensiKeluar = $('#btnPresensiKeluar');
        const btnUploadLaporan = $('#btnUploadLaporan');

        // Presensi Masuk: 09:00 - 10:00
        if (currentData.sudahMasuk) {
        btnPresensiMasuk.prop('disabled', true)
            .removeClass('btn-success').addClass('btn-secondary')
            .html('<i class="mdi mdi-check mr-2"></i>Sudah Presensi');
        } else if (!isTimeAllowed(1, 24)) {
        btnPresensiMasuk.prop('disabled', true)
            .removeClass('btn-success').addClass('btn-secondary')
            .html('<i class="mdi mdi-clock-alert mr-2"></i>Waktu Habis');
        } else {
        btnPresensiMasuk.prop('disabled', false)
            .removeClass('btn-secondary').addClass('btn-success')
            .html('<i class="mdi mdi-login mr-2"></i>Presensi Masuk');
        }

        // Presensi Keluar: 16:00 - 17:00
        if (currentData.sudahKeluar) {
        btnPresensiKeluar.prop('disabled', true)
            .removeClass('btn-warning').addClass('btn-secondary')
            .html('<i class="mdi mdi-check mr-2"></i>Sudah Keluar');
        } else if (!currentData.sudahMasuk) {
        btnPresensiKeluar.prop('disabled', true)
            .removeClass('btn-warning').addClass('btn-secondary')
            .html('<i class="mdi mdi-alert mr-2"></i>Masuk Dulu');
        } else if (!isTimeAllowed(1, 24)) {
        btnPresensiKeluar.prop('disabled', true)
            .removeClass('btn-warning').addClass('btn-secondary')
            .html('<i class="mdi mdi-clock-alert mr-2"></i>Waktu Habis');
        } else {
        btnPresensiKeluar.prop('disabled', false)
            .removeClass('btn-secondary').addClass('btn-warning')
            .html('<i class="mdi mdi-logout mr-2"></i>Presensi Keluar');
        }

        // Upload Laporan: 16:00 - 24:00 (23:59)
        if (!isTimeAllowed(1, 24)) {
        btnUploadLaporan.prop('disabled', true)
            .removeClass('btn-info').addClass('btn-secondary')
            .html('<i class="mdi mdi-clock-alert mr-2"></i>Waktu Habis');
        } else {
        btnUploadLaporan.prop('disabled', false)
            .removeClass('btn-secondary').addClass('btn-info');
        
        if (currentData.sudahLaporan) {
            btnUploadLaporan.html('<i class="mdi mdi-pencil mr-2"></i>Edit Laporan');
        } else {
            btnUploadLaporan.html('<i class="mdi mdi-upload mr-2"></i>Upload Laporan');
        }
        }
    }

    // Initial setup
    parseDataFromTable();
    updateCurrentTime();
    updateButtonStatus();
    
    // Update setiap detik
    setInterval(function() {
        updateCurrentTime();
        updateButtonStatus();
    }, 1000);

    // Handle edit laporan button
    $(document).on('click', '.edit-laporan-btn', function() {
        const id = $(this).data('id');
        if (id) {
        $('#formEditLaporan').attr('action', '/laporan-harian-update/');
        }
    });

    // Confirm edit laporan
    $('#btnConfirmEdit').click(function() {
        $('#formEditLaporan').submit();
    });

    // PDF Viewer functionality
    const usePdfjs = true;
    const pdfjsViewerUrl = '/pdfjs/web/viewer.html';
    const $modal = $('#modalPdf');
    const $loader = $('#loader');
    const $iframe = $('#pdfFrame');
    const $error = $('#error');
    const $downloadBtn = $('#downloadBtn');
    const $openNewTab = $('#openNewTab');
    const $errorOpen = $('#errorOpen');
    const $errorDownload = $('#errorDownload');

    function adjustIframeHeight() {
        const headerH = $modal.find('.modal-header').outerHeight() || 0;
        const footerH = $modal.find('.modal-footer').outerHeight() || 0;
        const topOffset = 20;
        const vh = Math.max(window.innerHeight || $(window).height(), 600);
        const available = Math.max(200, vh - headerH - footerH - topOffset);
        $iframe.css('height', available + 'px');
    }

    $(document).on('click', '.show-pdf-btn', function() {
        const file = $(this).data('file');
        const nama = $(this).data('nama') || 'Laporan Harian';
        $modal.find('.modal-title').text('Laporan Harian — ' + nama);
        $loader.addClass('show');
        $iframe.hide();
        $error.hide();
        $downloadBtn.attr('href', '#');
        $openNewTab.attr('href', '#');
        $errorOpen.attr('href', '#');
        $errorDownload.attr('href', '#');
        $iframe.attr('src', '');

        if (!file) {
        $loader.removeClass('show');
        $error.show();
        $modal.modal('show');
        return;
        }

        adjustIframeHeight();

        function loadWithSrc(usedSrc) {
        $downloadBtn.attr('href', file);
        $openNewTab.attr('href', file);
        $errorOpen.attr('href', file);
        $errorDownload.attr('href', file);
        let loaded = false;
        $iframe.off('load').on('load', function() {
            loaded = true;
            $loader.removeClass('show');
            $error.hide();
            $iframe.show();
        });
        $iframe.attr('src', usedSrc);
        setTimeout(function() {
            if (!loaded) {
            $loader.removeClass('show');
            $iframe.hide();
            $error.show();
            }
        }, 10000);
        }

        if (usePdfjs) {
        fetch(pdfjsViewerUrl, { method: 'HEAD' }).then(function(r) {
            const viewerOk = r.ok;
            const usedSrc = viewerOk ? pdfjsViewerUrl + '?file=' + encodeURIComponent(file) + '#zoom=page-fit' : file;
            loadWithSrc(usedSrc);
        }).catch(function() {
            loadWithSrc(file);
        });
        } else {
        loadWithSrc(file);
        }

        $modal.modal('show');
    });

    $modal.on('shown.bs.modal', function() {
        adjustIframeHeight();
    });

    $(window).on('resize.modalPdf', function() {
        if ($modal.hasClass('show')) adjustIframeHeight();
    });

    $modal.on('hidden.bs.modal', function() {
        $iframe.attr('src', '');
        $loader.removeClass('show');
        $error.hide();
    });

    // Validation untuk file upload
    $('#laporanFile, #editLaporanFile').change(function() {
        const file = this.files[0];
        if (file) {
        if (file.type !== 'application/pdf') {
            alert('File harus berformat PDF');
            this.value = '';
            return;
        }
        if (file.size > 5 * 1024 * 1024) {
            alert('Ukuran file terlalu besar. Maksimal 5 MB');
            this.value = '';
            return;
        }
        }
    });

    // Handle form submissions untuk loading state
    $('form[action="/peserta/presensi-masuk"], form[action="/peserta/presensi-keluar"]').on('submit', function() {
        const btn = $(this).find('button[type="submit"]');
        btn.prop('disabled', true).html('<i class="mdi mdi-loading mdi-spin mr-2"></i>Memproses...');
    });
    });
    </script>